<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesan Menu Kekinian</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/heroicons/2.1.3/24/solid/heroicons.min.css" xintegrity="sha512-6S0noUq0GuY2J3lN1P/4xrjYjAt7h/1TnlY1uB25bZ1JqFp8r/6h/mP/bMopQp/32M7qpHp1b90/e1y1S1TfQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .fade-out { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        input[type="radio"]:checked + div { border-color: #10b981; box-shadow: 0 0 0 2px #a7f3d0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Style untuk tombol disabled */
        button:disabled {
            background-color: #d1d5db; /* gray-300 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- ===== HEADER / NAVIGASI ===== -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40">
        <nav class="container mx-auto max-w-5xl px-4 py-4 flex justify-between items-center">
            <a href="#" class="text-2xl font-extrabold text-gray-900" onclick="showPage('menu-page')">
                Kafe<span class="text-emerald-500">Kini</span>.
            </a>
            <button onclick="showPage('cart-page')" class="relative p-2 rounded-full text-gray-700 hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007Z" /></svg>
                <span id="cart-count-badge" class="absolute -top-1 -right-1 bg-emerald-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center border-2 border-white">0</span>
            </button>
        </nav>
    </header>

    <!-- ===== MAIN CONTENT (KONTEN UTAMA) ===== -->
    <main class="container mx-auto max-w-5xl p-4">

        <!-- ===== HALAMAN 1: MENU ===== -->
        <section id="menu-page" class="page-section">
            
            <!-- Banner Promo -->
            <div class="bg-gradient-to-r from-emerald-500 to-green-600 text-white p-6 md:p-8 rounded-2xl shadow-lg mb-8 relative overflow-hidden">
                <h2 class="text-3xl md:text-4xl font-extrabold mb-2">Diskon Kilat!</h2>
                <p class="text-lg md:text-xl">Pesan 2 Kopi Susu Gula Aren, Gratis 1 Croissant. ü•ê</p>
                <div class="absolute -bottom-8 -right-8 w-32 h-32 bg-white/20 rounded-full"></div>
                <div class="absolute top-4 -left-10 w-24 h-24 bg-white/10 rounded-full"></div>
            </div>

            <!-- Bagian: Menu Populer (Horizontal Scroll) -->
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Paling Laris üî•</h2>
            <div id="popular-menu-container" class="flex overflow-x-auto space-x-4 pb-4 no-scrollbar">
                <!-- Konten Menu Populer di-generate oleh JS dari Firestore -->
            </div>

            <!-- Bagian: Semua Menu (Grid) -->
            <h2 class="text-2xl font-bold text-gray-900 mb-4 mt-8">Semua Menu</h2>
            <div id="all-menu-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Konten Menu di-generate oleh JS dari Firestore -->
            </div>
            <div id="menu-loading" class="text-center py-10 text-gray-500">
                <p>Memuat menu...</p>
            </div>

        </section>

        <!-- ===== HALAMAN 2: KERANJANG & PEMBAYARAN ===== -->
        <section id="cart-page" class="page-section" style="display: none;">
            
            <div class="flex items-center mb-6">
                <button onclick="showPage('menu-page')" class="p-2 rounded-full hover:bg-gray-100 mr-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-gray-700"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>
                </button>
                <h1 class="text-3xl font-extrabold text-gray-900">Keranjang Kamu üõí</h1>
            </div>

            <div class="flex flex-col lg:flex-row gap-8">
                
                <!-- Kolom Kiri: Item Keranjang & Info Pelanggan -->
                <div class="w-full lg:w-2/3 space-y-8">
                    <!-- Daftar Item -->
                    <div id="cart-items-container" class="space-y-4">
                        <!-- Konten Keranjang di-generate oleh JS -->
                    </div>

                    <!-- Tampilan jika keranjang kosong -->
                    <div id="cart-empty-state" class="text-center py-12 bg-white rounded-2xl shadow" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-gray-300 mx-auto mb-4"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c.121 0 .239.04.332.114.092.075.15.19.15.312l-1.018 5.601a1.125 1.125 0 0 1-1.12.969h-7.144a1.125 1.125 0 0 1-1.12-.97l-1.017-5.603a.375.375 0 0 1 .15-.312.375.375 0 0 1 .332-.114Z" /></svg>
                        <h3 class="text-xl font-semibold text-gray-700">Keranjangmu masih kosong</h3>
                        <p class="text-gray-500 mb-4">Yuk, pilih menu favoritmu!</p>
                        <button onclick="showPage('menu-page')" class="bg-emerald-500 text-white font-bold py-2 px-6 rounded-full hover:bg-emerald-600 transition-colors">
                            Lihat Menu
                        </button>
                    </div>

                    <!-- Info Pelanggan -->
                    <div class="bg-white p-6 rounded-2xl shadow">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Info Pelanggan</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Pelanggan</label>
                                <input type="text" id="customer-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-300 focus:border-emerald-500" placeholder="Masukkan nama lengkapmu...">
                            </div>
                            <div>
                                <label for="customer-phone" class="block text-sm font-medium text-gray-700 mb-1">No. Telepon (WhatsApp)</label>
                                <input type="tel" id="customer-phone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-300 focus:border-emerald-500" placeholder="Contoh: 08123456789">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pilihan Servis -->
                    <div class="bg-white p-6 rounded-2xl shadow">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">Pilihan Servis</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label>
                                <input type="radio" name="service" value="Dine In" class="sr-only" onchange="handleServiceChange(this.value)" checked>
                                <div class="p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-gray-300">
                                    <span class="text-3xl mb-1">üçΩÔ∏è</span>
                                    <h4 class="font-bold text-gray-800">Dine In</h4>
                                    <p class="text-sm text-gray-500">Makan di tempat</p>
                                </div>
                            </label>
                            <label>
                                <input type="radio" name="service" value="Takeaway" class="sr-only" onchange="handleServiceChange(this.value)">
                                <div class="p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-gray-300">
                                    <span class="text-3xl mb-1">üõçÔ∏è</span>
                                    <h4 class="font-bold text-gray-800">Takeaway</h4>
                                    <p class="text-sm text-gray-500">Ambil sendiri</p>
                                </div>
                            </label>
                            <label>
                                <input type="radio" name="service" value="Delivery" class="sr-only" onchange="handleServiceChange(this.value)">
                                <div class="p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-gray-300">
                                    <span class="text-3xl mb-1">üõµ</span>
                                    <h4 class="font-bold text-gray-800">Delivery</h4>
                                    <p class="text-sm text-gray-500">Antar ke lokasimu</p>
                                </div>
                            </label>
                        </div>
                        
                        <div id="delivery-address-form" class="mt-4" style="display: none;">
                            <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Alamat Pengantaran</label>
                            <textarea id="address" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-300 focus:border-emerald-500" placeholder="Masukkan alamat lengkapmu..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Kolom Kanan: Ringkasan Pembayaran (Sticky) -->
                <div class="w-full lg:w-1/3">
                    <div id="payment-summary-card" class="bg-white p-6 rounded-2xl shadow-lg lg:sticky lg:top-24">
                        
                        <div class="mb-5">
                            <p id="free-shipping-text" class="text-sm font-medium text-emerald-700 mb-2">Tinggal sedikit lagi!</p>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="free-shipping-progress" class="bg-emerald-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>

                        <h3 class="text-xl font-bold text-gray-900 border-b pb-3 mb-4">Ringkasan Pesanan</h3>
                        <div class="space-y-2 text-gray-700">
                            <div class="flex justify-between">
                                <span>Subtotal</span>
                                <span id="summary-subtotal" class="font-medium">Rp 0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Biaya Layanan</span>
                                <span id="summary-service-fee" class="font-medium">Rp 0</span>
                            </div>
                            <div class="flex justify-between" id="summary-delivery-fee-row" style="display: none;">
                                <span>Biaya Pengantaran</span>
                                <span id="summary-delivery-fee" class="font-medium">Rp 0</span>
                            </div>
                        </div>

                        <div class="flex justify-between text-xl font-bold text-gray-900 border-t mt-4 pt-4">
                            <span>Total</span>
                            <span id="summary-total">Rp 0</span>
                        </div>

                        <div class="mt-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Metode Pembayaran</h4>
                            <select id="payment-method" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-emerald-300 focus:border-emerald-500">
                                <option value="">Pilih Pembayaran</option>
                                <option value="QRIS">QRIS</option>
                                <option value="E-Wallet">E-Wallet (OVO, GoPay, Dana)</option>
                                <option value="COD">Cash on Delivery (COD)</option>
                                <option value="Transfer">Transfer Bank</option>
                            </select>
                        </div>

                        <!-- PERBAIKAN: Tombol di-disable secara default -->
                        <button id="checkout-button" onclick="handleCheckout()" class="w-full bg-emerald-500 text-white text-lg font-bold py-3 px-6 rounded-full hover:bg-emerald-600 transition-colors mt-6 shadow-lg hover:shadow-emerald-300 disabled:bg-gray-300 disabled:shadow-none" disabled>
                            Kirim Pesanan
                        </button>
                        <!-- PERBAIKAN: Status koneksi -->
                        <p id="checkout-db-status" class="text-xs text-center text-gray-500 mt-2">Menghubungkan ke server...</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- ===== FOOTER ===== -->
    <footer class="text-center p-8 mt-12 text-gray-500 text-sm">
        &copy; 2025 KafeKini. Dibuat dengan ‚ù§Ô∏è untuk pelanggan kami.
    </footer>


    <!-- ===== MODAL: ADD-ONS (FITUR UPSALE) ===== -->
    <div id="addon-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in" style="display: none;">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
            <div id="modal-content-container"></div>
        </div>
    </div>

    <!-- ===== NOTIFIKASI KUSTOM (Pengganti alert) ===== -->
    <div id="custom-notification" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg fade-in" style="display: none; z-index: 100;">
        <span id="notification-message"></span>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, getDocs, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === KONFIGURASI FIREBASE ===
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "AIzaSyDWpnos_9NRj0LVA0J6KBf4bxNtWCXF7Xw", authDomain: "outlet-masdar.firebaseapp.com", projectId: "outlet-masdar", storageBucket: "outlet-masdar.firebasestorage.app", messagingSenderId: "661483386947", appId: "1:661483386947:web:0b2f26c227cb5fe130bcf6" };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inisialisasi Firebase
        let app, auth, db, userId;
        let menuCollection, ordersCollection;

        // PERBAIKAN: Ambil referensi elemen UI
        const checkoutButton = document.getElementById('checkout-button');
        const checkoutDbStatus = document.getElementById('checkout-db-status');
        const menuLoading = document.getElementById('menu-loading');

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Path koleksi
            const basePath = `artifacts/${appId}/public/data`;
            menuCollection = collection(db, `${basePath}/menu`);
            ordersCollection = collection(db, `${basePath}/orders`);

            // PERBAIKAN: Set persistensi
            await setPersistence(auth, browserLocalPersistence);

            // Autentikasi
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User terautentikasi:", userId);
                    // Setelah auth siap, muat menu
                    loadMenuFromFirestore();

                    // PERBAIKAN: Aktifkan tombol checkout
                    checkoutButton.disabled = false;
                    checkoutDbStatus.textContent = 'Koneksi siap!';
                    checkoutDbStatus.classList.add('text-green-600');
                } else {
                    checkoutButton.disabled = true;
                    checkoutDbStatus.textContent = 'Menghubungkan ke server...';
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (authError) {
                        console.error("Gagal autentikasi:", authError);
                        checkoutDbStatus.textContent = 'Gagal terhubung. Coba refresh.';
                        checkoutDbStatus.classList.add('text-red-600');
                    }
                }
            });

        } catch (e) {
            console.error("Gagal inisialisasi Firebase:", e);
            menuLoading.innerText = "Gagal terhubung ke database. Coba refresh.";
            checkoutDbStatus.textContent = 'Error Inisialisasi Firebase!';
            checkoutDbStatus.classList.add('text-red-600');
        }
        
        // === DATABASE PRODUK (diambil dari Firestore) ===
        let allProducts = []; 

        // === STATE APLIKASI ===
        let cart = []; 
        let currentPage = 'menu-page';
        let currentService = 'Dine In';
        let currentItemToAdd = null; 

        // === KONSTANTA ===
        const SERVICE_FEE = 2000;
        const DELIVERY_FEE = 12000;
        const FREE_SHIPPING_THRESHOLD = 75000;

        // === FUNGSI UTAMA ===
        
        window.showPage = showPage;
        window.openAddonModal = openAddonModal;
        window.closeAddonModal = closeAddonModal;
        window.confirmAddToCart = confirmAddToCart;
        window.updateQuantity = updateQuantity;
        window.removeFromCart = removeFromCart;
        window.handleServiceChange = handleServiceChange;
        window.handleCheckout = handleCheckout;

        document.addEventListener('DOMContentLoaded', () => {
            renderCart();
            updateCartCountBadge();
        });

        // === Muat Menu dari Firestore ===
        function loadMenuFromFirestore() {
            onSnapshot(menuCollection, (snapshot) => {
                allProducts = []; 
                if (snapshot.empty) {
                    menuLoading.innerText = "Belum ada menu yang tersedia.";
                    renderAllMenu(); // Render (kosong)
                    renderPopularMenu(); // Render (kosong)
                    return;
                }
                
                snapshot.forEac
